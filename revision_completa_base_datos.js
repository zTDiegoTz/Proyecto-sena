// ============================================================================
// REVISI√ìN COMPLETA DE BASE DE DATOS - ESTACI√ìN DE GASOLINA
// ============================================================================
// Script para realizar una revisi√≥n exhaustiva de toda la base de datos

const { createClient } = require('@supabase/supabase-js')

const supabaseUrl = 'https://adbzfiepkxtyqudwfysk.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkYnpmaWVwa3h0eXF1ZHdmeXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzI4NTMsImV4cCI6MjA3MzAwODg1M30.p28PzncJkprjEluCMsFsaqio0zTsrRrzM2whZ52_rtI'

const supabase = createClient(supabaseUrl, supabaseAnonKey)

async function revisarUsuarios() {
  try {
    console.log('\nüë• REVISANDO USUARIOS...')
    
    const { data: usuarios, error } = await supabase
      .from('users')
      .select('*')
      .orderBy('created_at', { ascending: false })
    
    if (error) {
      console.log('‚ùå Error obteniendo usuarios:', error.message)
      return
    }
    
    console.log(`üìä Total de usuarios: ${usuarios.length}`)
    
    // Agrupar por roles
    const roles = usuarios.reduce((acc, u) => {
      acc[u.role] = (acc[u.role] || 0) + 1
      return acc
    }, {})
    
    console.log('üìã Usuarios por rol:')
    Object.entries(roles).forEach(([rol, cantidad]) => {
      console.log(`   - ${rol}: ${cantidad}`)
    })
    
    // Mostrar usuarios activos
    const usuariosActivos = usuarios.filter(u => u.activo)
    console.log(`\n‚úÖ Usuarios activos: ${usuariosActivos.length}`)
    
    usuariosActivos.forEach((u, i) => {
      console.log(`   ${i+1}. ${u.name} (${u.username}) - ${u.role}`)
    })
    
    return usuarios.length
    
  } catch (error) {
    console.log('‚ùå Error revisando usuarios:', error.message)
    return 0
  }
}

async function revisarSurtidores() {
  try {
    console.log('\n‚õΩ REVISANDO SURTIDORES...')
    
    const { data: surtidores, error } = await supabase
      .from('surtidores')
      .select(`
        *,
        combustibles_surtidor(*)
      `)
      .orderBy('nombre')
    
    if (error) {
      console.log('‚ùå Error obteniendo surtidores:', error.message)
      return
    }
    
    console.log(`üìä Total de surtidores: ${surtidores.length}`)
    
    surtidores.forEach((surtidor, i) => {
      console.log(`\n${i+1}. ${surtidor.nombre}`)
      console.log(`   Estado: ${surtidor.estado}`)
      console.log(`   Ubicaci√≥n: ${surtidor.ubicacion}`)
      console.log(`   Combustibles: ${surtidor.combustibles_surtidor.length}`)
      
      surtidor.combustibles_surtidor.forEach(comb => {
        console.log(`     - ${comb.tipo_combustible}: ${comb.stock} gal (Stock) | ${comb.vendido} gal (Vendido) | $${comb.precio}`)
      })
    })
    
    return surtidores.length
    
  } catch (error) {
    console.log('‚ùå Error revisando surtidores:', error.message)
    return 0
  }
}

async function revisarVentas() {
  try {
    console.log('\nüí∞ REVISANDO VENTAS...')
    
    const { data: ventas, error } = await supabase
      .from('ventas')
      .select('*')
      .orderBy('fecha_venta', { ascending: false })
      .limit(10)
    
    if (error) {
      console.log('‚ùå Error obteniendo ventas:', error.message)
      return
    }
    
    console.log(`üìä √öltimas 10 ventas (Total: ${ventas.length})`)
    
    if (ventas.length === 0) {
      console.log('‚ö†Ô∏è  No hay ventas registradas')
      return 0
    }
    
    ventas.forEach((venta, i) => {
      console.log(`\n${i+1}. Venta ${venta.id.substring(0, 8)}...`)
      console.log(`   Fecha: ${new Date(venta.fecha_venta).toLocaleDateString('es-ES')}`)
      console.log(`   Surtidor: ${venta.surtidor_nombre}`)
      console.log(`   Bombero: ${venta.bombero_nombre}`)
      console.log(`   Combustible: ${venta.tipo_combustible}`)
      console.log(`   Cantidad: ${venta.cantidad} gal`)
      console.log(`   Total: $${venta.valor_total?.toLocaleString('es-ES')}`)
      console.log(`   M√©todo: ${venta.metodo_pago}`)
    })
    
    // Estad√≠sticas de ventas
    const totalVentas = ventas.reduce((sum, v) => sum + (v.valor_total || 0), 0)
    const totalGalones = ventas.reduce((sum, v) => sum + (v.cantidad || 0), 0)
    
    console.log(`\nüìà Estad√≠sticas de las √∫ltimas ventas:`)
    console.log(`   Total vendido: $${totalVentas.toLocaleString('es-ES')}`)
    console.log(`   Total galones: ${totalGalones.toFixed(2)} gal`)
    
    return ventas.length
    
  } catch (error) {
    console.log('‚ùå Error revisando ventas:', error.message)
    return 0
  }
}

async function revisarConfiguracionCombustibles() {
  try {
    console.log('\n‚öôÔ∏è  REVISANDO CONFIGURACI√ìN DE COMBUSTIBLES...')
    
    const { data: config, error } = await supabase
      .from('configuracion_combustibles')
      .select('*')
      .orderBy('tipo_combustible')
    
    if (error) {
      console.log('‚ùå Error obteniendo configuraci√≥n:', error.message)
      return
    }
    
    console.log(`üìä Tipos de combustible configurados: ${config.length}`)
    
    config.forEach((c, i) => {
      console.log(`\n${i+1}. ${c.tipo_combustible.toUpperCase()}`)
      console.log(`   Precio por litro: $${c.precio_por_litro?.toLocaleString('es-ES')}`)
      console.log(`   Precio por gal√≥n: $${c.precio_por_galon?.toLocaleString('es-ES')}`)
      console.log(`   Estado: ${c.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}`)
      console.log(`   √öltima actualizaci√≥n: ${new Date(c.fecha_actualizacion).toLocaleDateString('es-ES')}`)
    })
    
    return config.length
    
  } catch (error) {
    console.log('‚ùå Error revisando configuraci√≥n:', error.message)
    return 0
  }
}

async function revisarInventario() {
  try {
    console.log('\nüì¶ REVISANDO INVENTARIO...')
    
    const { data: inventario, error } = await supabase
      .from('combustibles_surtidor')
      .select(`
        *,
        surtidores(nombre, estado)
      `)
      .orderBy('surtidor_id')
    
    if (error) {
      console.log('‚ùå Error obteniendo inventario:', error.message)
      return
    }
    
    console.log(`üìä Total de registros de inventario: ${inventario.length}`)
    
    // Agrupar por surtidor
    const porSurtidor = inventario.reduce((acc, item) => {
      const surtidor = item.surtidores?.nombre || 'Desconocido'
      if (!acc[surtidor]) acc[surtidor] = []
      acc[surtidor].push(item)
      return acc
    }, {})
    
    Object.entries(porSurtidor).forEach(([surtidor, items]) => {
      console.log(`\n‚õΩ ${surtidor}:`)
      items.forEach(item => {
        const porcentajeStock = ((item.stock / item.capacidad_maxima) * 100).toFixed(1)
        console.log(`   - ${item.tipo_combustible}: ${item.stock}/${item.capacidad_maxima} gal (${porcentajeStock}%)`)
        console.log(`     Vendido: ${item.vendido} gal | Precio: $${item.precio}`)
      })
    })
    
    // Estad√≠sticas generales
    const totalStock = inventario.reduce((sum, item) => sum + item.stock, 0)
    const totalVendido = inventario.reduce((sum, item) => sum + item.vendido, 0)
    const totalCapacidad = inventario.reduce((sum, item) => sum + item.capacidad_maxima, 0)
    
    console.log(`\nüìà Estad√≠sticas generales:`)
    console.log(`   Stock total: ${totalStock.toFixed(2)} gal`)
    console.log(`   Vendido total: ${totalVendido.toFixed(2)} gal`)
    console.log(`   Capacidad total: ${totalCapacidad.toFixed(2)} gal`)
    console.log(`   Disponibilidad: ${((totalStock / totalCapacidad) * 100).toFixed(1)}%`)
    
    return inventario.length
    
  } catch (error) {
    console.log('‚ùå Error revisando inventario:', error.message)
    return 0
  }
}

async function revisarIntegridadReferencial() {
  try {
    console.log('\nüîó REVISANDO INTEGRIDAD REFERENCIAL...')
    
    // Verificar ventas con surtidores v√°lidos
    const { data: ventas, error: ventasError } = await supabase
      .from('ventas')
      .select('id, surtidor_id, surtidor_nombre')
    
    const { data: surtidores, error: surtidoresError } = await supabase
      .from('surtidores')
      .select('id')
    
    if (ventasError || surtidoresError) {
      console.log('‚ùå Error verificando integridad:', ventasError?.message || surtidoresError?.message)
      return
    }
    
    const idsSurtidoresValidos = surtidores.map(s => s.id)
    const ventasInvalidas = ventas.filter(v => !idsSurtidoresValidos.includes(v.surtidor_id))
    
    if (ventasInvalidas.length > 0) {
      console.log(`‚ö†Ô∏è  Ventas con surtidores inv√°lidos: ${ventasInvalidas.length}`)
      ventasInvalidas.forEach(v => {
        console.log(`   - Venta ${v.id}: Surtidor ${v.surtidor_id} no existe`)
      })
    } else {
      console.log('‚úÖ Todas las ventas tienen surtidores v√°lidos')
    }
    
    // Verificar ventas con usuarios v√°lidos
    const { data: usuarios, error: usuariosError } = await supabase
      .from('users')
      .select('id')
    
    if (!usuariosError && usuarios) {
      const idsUsuariosValidos = usuarios.map(u => u.id)
      const ventasUsuariosInvalidos = ventas.filter(v => !idsUsuariosValidos.includes(v.bombero_id))
      
      if (ventasUsuariosInvalidos.length > 0) {
        console.log(`‚ö†Ô∏è  Ventas con usuarios inv√°lidos: ${ventasUsuariosInvalidos.length}`)
        ventasUsuariosInvalidos.forEach(v => {
          console.log(`   - Venta ${v.id}: Usuario ${v.bombero_id} no existe`)
        })
      } else {
        console.log('‚úÖ Todas las ventas tienen usuarios v√°lidos')
      }
    }
    
    return ventasInvalidas.length === 0
    
  } catch (error) {
    console.log('‚ùå Error revisando integridad:', error.message)
    return false
  }
}

async function generarResumenEjecutivo() {
  try {
    console.log('\nüìä GENERANDO RESUMEN EJECUTIVO...')
    
    // Obtener estad√≠sticas generales
    const { data: totalVentas, error: ventasError } = await supabase
      .from('ventas')
      .select('valor_total, cantidad')
    
    const { data: totalUsuarios, error: usuariosError } = await supabase
      .from('users')
      .select('activo')
    
    const { data: totalSurtidores, error: surtidoresError } = await supabase
      .from('surtidores')
      .select('estado')
    
    if (ventasError || usuariosError || surtidoresError) {
      console.log('‚ùå Error generando resumen:', ventasError?.message || usuariosError?.message || surtidoresError?.message)
      return
    }
    
    const ingresosTotales = totalVentas.reduce((sum, v) => sum + (v.valor_total || 0), 0)
    const galonesVendidos = totalVentas.reduce((sum, v) => sum + (v.cantidad || 0), 0)
    const usuariosActivos = totalUsuarios.filter(u => u.activo).length
    const surtidoresDisponibles = totalSurtidores.filter(s => s.estado === 'disponible').length
    
    console.log('\n' + '='.repeat(60))
    console.log('üìã RESUMEN EJECUTIVO - ESTACI√ìN DE GASOLINA')
    console.log('='.repeat(60))
    console.log(`üí∞ Ingresos totales: $${ingresosTotales.toLocaleString('es-ES')}`)
    console.log(`‚õΩ Galones vendidos: ${galonesVendidos.toFixed(2)} gal`)
    console.log(`üë• Usuarios activos: ${usuariosActivos}`)
    console.log(`‚õΩ Surtidores disponibles: ${surtidoresDisponibles}/${totalSurtidores.length}`)
    console.log(`üìä Total de ventas: ${totalVentas.length}`)
    console.log('='.repeat(60))
    
    // Estado del sistema
    const estadoSistema = usuariosActivos > 0 && surtidoresDisponibles > 0 && totalVentas.length >= 0
    console.log(`üéØ Estado del sistema: ${estadoSistema ? '‚úÖ OPERATIVO' : '‚ö†Ô∏è  REQUIERE ATENCI√ìN'}`)
    
    if (estadoSistema) {
      console.log('‚úÖ Base de datos completamente funcional')
      console.log('‚úÖ Todos los m√≥dulos operativos')
      console.log('‚úÖ Sistema listo para producci√≥n')
    } else {
      console.log('‚ö†Ô∏è  Se requiere revisi√≥n adicional')
    }
    
    return estadoSistema
    
  } catch (error) {
    console.log('‚ùå Error generando resumen:', error.message)
    return false
  }
}

async function main() {
  try {
    console.log('üîç INICIANDO REVISI√ìN COMPLETA DE BASE DE DATOS...')
    console.log('üìÖ Fecha:', new Date().toLocaleDateString('es-ES'))
    console.log('‚è∞ Hora:', new Date().toLocaleTimeString('es-ES'))
    
    // Ejecutar todas las revisiones
    const usuarios = await revisarUsuarios()
    const surtidores = await revisarSurtidores()
    const ventas = await revisarVentas()
    const config = await revisarConfiguracionCombustibles()
    const inventario = await revisarInventario()
    const integridad = await revisarIntegridadReferencial()
    const resumen = await generarResumenEjecutivo()
    
    console.log('\nüéâ REVISI√ìN COMPLETA FINALIZADA üéâ')
    console.log('üìä Resumen de la revisi√≥n:')
    console.log(`   üë• Usuarios revisados: ${usuarios}`)
    console.log(`   ‚õΩ Surtidores revisados: ${surtidores}`)
    console.log(`   üí∞ Ventas revisadas: ${ventas}`)
    console.log(`   ‚öôÔ∏è  Configuraciones revisadas: ${config}`)
    console.log(`   üì¶ Registros de inventario: ${inventario}`)
    console.log(`   üîó Integridad referencial: ${integridad ? '‚úÖ Correcta' : '‚ùå Problemas'}`)
    console.log(`   üìã Estado general: ${resumen ? '‚úÖ √ìptimo' : '‚ö†Ô∏è  Requiere atenci√≥n'}`)
    
    if (resumen && integridad) {
      console.log('\nüöÄ SISTEMA COMPLETAMENTE OPERATIVO')
      console.log('‚úÖ Base de datos en perfecto estado')
      console.log('‚úÖ Todas las funcionalidades disponibles')
      console.log('‚úÖ Listo para uso en producci√≥n')
    }
    
  } catch (error) {
    console.log('‚ùå Error durante la revisi√≥n:', error.message)
  }
}

main()
